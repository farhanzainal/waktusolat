<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prayers Time</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.13/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/41bcea2ae3.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .current-prayer {
            border: 2px solid #4CAF50;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .exclude-print {
                visibility: hidden !important  ;
            }
            #monthlyPrayerTimesSection, #monthlyPrayerTimesSection * {
                visibility: visible;
            }
            #monthlyPrayerTimesSection {
                width: 100%;
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body>

    <div id="locationPrompt" class="container mx-auto flex flex-col items-center justify-center h-screen">
        <h2 class="text-xl font-bold mb-4">Akses ke lokasi anda</h2>
        <p>Benarkan untuk mengakses lokasi anda?</p>
        
        <div class="flex flex-row mt-2"><button id="denyLocation" class="btn btn-neutral mr-2 btn-sm">Tidak</button><button id="allowLocation" class="btn btn-success btn-sm">Ya</button></div>
    </div>

    <div id="mainContent" class="container mx-auto p-4" style="display: none;">

        <h1 class="text-2xl font-bold mb-4">Tempat Anda</h1>

        <div class="grid grid-cols-1 sm:grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-4">
            <div class="flex flex-col items-center p-4 bg-gray-800 rounded-lg shadow-md">
                <h3 class="font-semibold text-lg mb-1 text-white">Kod Jakim</h3>
                <p id="zoneCode" class="text-lg text-white"></p>
            </div>
            <div  class=" flex flex-col items-center p-4 bg-gray-800 rounded-lg shadow-md">
                <h3 class="font-semibold text-lg mb-1 text-white">Daerah</h3>
                <p id="zoneDistrict" class="text-lg  text-white"></p>
            </div>
            <div  class=" flex flex-col items-center p-4 bg-gray-800 rounded-lg shadow-md">
                <h3 class="font-semibold text-lg mb-1 text-white">Negeri</h3>
                <p id="zoneState" class="text-lg  text-white"></p>
            </div>
              
        </div>



        <h1 class="text-2xl font-bold mb-4 mt-8">Waktu Solat Hari Ini</h1>
        <div id="allPrayerTimes" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
            <div id="fajrCard" class="prayer-time flex flex-col items-center p-4 bg-gray-800 rounded-lg shadow-md">
                <img src="images/fajr.png" alt="Fajr" class="h-12 w-12 mb-2">
                <h3 class="font-semibold text-lg mb-1 text-white">Subuh</h3>
                <p id="fajrTime" class="text-xl font-bold text-white"></p>
            </div>
            <div id="dhuhrCard" class="prayer-time flex flex-col items-center p-4 bg-gray-800 rounded-lg shadow-md">
                <img src="images/dhuhr.png" alt="Dhuhr" class="h-12 w-12 mb-2">
                <h3 class="font-semibold text-lg mb-1 text-white">Zuhur</h3>
                <p id="dhuhrTime" class="text-xl font-bold text-white"></p>
            </div>
            <div id="asrCard" class="prayer-time flex flex-col items-center p-4 bg-gray-800 rounded-lg shadow-md">
                <img src="images/asr.png" alt="Asr" class="h-12 w-12 mb-2">
                <h3 class="font-semibold text-lg mb-1 text-white">Asar</h3>
                <p id="asrTime" class="text-xl font-bold text-white"></p>
            </div>
            <div id="maghribCard" class="prayer-time flex flex-col items-center p-4 bg-gray-800 rounded-lg shadow-md">
                <img src="images/maghrib.png" alt="Maghrib" class="h-12 w-12 mb-2">
                <h3 class="font-semibold text-lg mb-1 text-white">Maghrib</h3>
                <p id="maghribTime" class="text-xl font-bold text-white"></p>
            </div>
            <div id="ishaCard" class="prayer-time flex flex-col items-center p-4 bg-gray-800 rounded-lg shadow-md col-span-2 sm:col-span-1">
                <img src="images/isha.png" alt="Isha" class="h-12 w-12 mb-2">
                <h3 class="font-semibold text-lg mb-1 text-white">Isya</h3>
                <p id="ishaTime" class="text-xl font-bold text-white"></p>
            </div>
        </div>

    <div id="monthlyPrayerTimesSection">
        <div class="flex justify-between items-center mb-4 mt-8">
            <h1 class="text-2xl font-bold">Waktu Solat Bulan Ini</h1>
            <button id="printButton" class="btn btn-primary exclude-print">Print Waktu Solat Bulan Ini</button>
        </div>
        <table id="monthlyPrayerTimes" class="table-auto w-full text-center bg-gray-800 rounded-lg shadow-md">
            <thead>
                <tr>
                    <th class="px-4 py-2 text-white">Hari</th>
                    <th class="px-4 py-2 text-white">Subuh</th>
                    <th class="px-4 py-2 text-white">Zuhur</th>
                    <th class="px-4 py-2 text-white">Asar</th>
                    <th class="px-4 py-2 text-white">Maghrib</th>
                    <th class="px-4 py-2 text-white">Isya</th>
                </tr>
            </thead>
            <tbody id="monthlyPrayerTimesBody">
        
            </tbody>
        </table>
    </div>

    </div>
    </div>



    <script>
        $(document).ready(function() {

            

            function showMainContent() {
                $("#locationPrompt").hide();
                $("#mainContent").show();
                fetchPrayerTimes();
            }

            function saveLocation(position) {
                var latitude = position.coords.latitude;
                var longitude = position.coords.longitude;
                localStorage.setItem('userLatitude', latitude);
                localStorage.setItem('userLongitude', longitude);
                showMainContent();
            }

            function handleLocationError(error) {
                showMainContent();
            }

            function checkStoredLocation() {
                var storedLatitude = localStorage.getItem('userLatitude');
                var storedLongitude = localStorage.getItem('userLongitude');
                if (storedLatitude && storedLongitude) {
                    showMainContent();
                    return true;
                }
                return false;
            }

            if (!checkStoredLocation()) {
                $("#locationPrompt").show();
                $("#allowLocation").click(function() {
                    if ("geolocation" in navigator) {
                        navigator.geolocation.getCurrentPosition(saveLocation, handleLocationError);
                    } else {
                    
                        showMainContent();
                    }
                });

                $("#denyLocation").click(function() {
                   alert("Location access denied");
                });
            }

            $("#printButton").click(function() {
                window.print();
            });
        });
    </script>

    <script>

        function formatTime(time) {

        const date = new Date(time * 1000);

        let hours = date.getHours();
        let minutes = date.getMinutes();
        let ampm = hours >= 12 ? 'PM' : 'AM';
        

        hours = hours % 12;
        hours = hours ? hours : 12; 

        hours = hours < 10 ? '0' + hours : hours;
        minutes = minutes < 10 ? '0' + minutes : minutes;
        
        return `${hours}:${minutes} ${ampm}`;
        }

        function fetchZone(zone) {
        return fetch(`https://api.waktusolat.app/zones/${zone}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
            
                $("#zoneCode").html(data[0].jakimCode);
                $("#zoneDistrict").html(data[0].daerah);
                $("#zoneState").html(data[0].negeri);
            })
            .catch(error => {
                console.error('There was a problem fetching the zone:', error.message);
                throw error;
            });
        }

        function fetchPrayerTimes() {
            const latitude = localStorage.getItem('userLatitude');
            const longitude = localStorage.getItem('userLongitude');
        
        
            if (latitude && longitude) {

                const apiUrl = `https://api.waktusolat.app/v2/solat/gps/${latitude}/${longitude}`;
   
                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        const zone = data.zone;
                        fetchZone(zone);
                        const today = new Date().getDate(); // Get the current day of the month (1-31)
                        
                        
                        displayPrayerTimes(data.prayers[today-1]);
                    })
                    .catch(error => {
                        console.error('There was a problem with the fetch operation:', error.message);
                    });
            } else {
                
            }               
        }
    
        function displayPrayerTimes(data) {
    
            
            $("#fajrTime").text(formatTime(data.fajr));
            $("#dhuhrTime").text(formatTime(data.dhuhr));
            $("#asrTime").text(formatTime(data.asr));
            $("#maghribTime").text(formatTime(data.maghrib));
            $("#ishaTime").text(formatTime(data.isha)); 

            const now = new Date();
            const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            
            let currentPrayer = '';
            if (currentTime < data.fajr) currentPrayer = 'isha';
            else if (currentTime < data.dhuhr) currentPrayer = 'fajr';
            else if (currentTime < data.asr) currentPrayer = 'dhuhr';
            else if (currentTime < data.maghrib) currentPrayer = 'asr';
            else if (currentTime < data.isha) currentPrayer = 'maghrib';
            else currentPrayer = 'isha';
            $('.prayer-time').removeClass('current-prayer');
            $(`#${currentPrayer}Card`).addClass('current-prayer');
        }
    </script>

    <script>
        function fetchMonthlyPrayerTimes() {
            var latitude = localStorage.getItem('userLatitude');
            var longitude = localStorage.getItem('userLongitude');
            var apiUrl = `https://api.waktusolat.app/v2/solat/gps/${latitude}/${longitude}`;

            $.get(apiUrl, function(data) {
                var prayerTimes = data.prayers;
                var tbody = $("#monthlyPrayerTimesBody");
                tbody.empty();

                prayerTimes.forEach(function(day, index) {

                    var row = `<tr>
                        <td class="px-4 py-2 text-white">${index + 1}</td>
                        <td class="px-4 py-2 text-white">${formatTime(day.fajr)}</td>
                        <td class="px-4 py-2 text-white">${formatTime(day.dhuhr)}</td>
                        <td class="px-4 py-2 text-white">${formatTime(day.asr)}</td>
                        <td class="px-4 py-2 text-white">${formatTime(day.maghrib)}</td>
                        <td class="px-4 py-2 text-white">${formatTime(day.isha)}</td>
                    </tr>`;
                    tbody.append(row);
                });
            });
        }

        $(document).ready(function() {
            fetchMonthlyPrayerTimes();
        });
    </script>
    
</body>
</html>
